<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>URL Monitor Dashboard</title>

    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f4f6f9;
      }
      .card-hover:hover {
        transform: scale(1.02);
        transition: 0.2s ease-in-out;
      }
      .details-row {
        display: none;
      }
    </style>

    <script>
      function toggleDetails(id) {
        let row = document.getElementById("details-" + id);

        if (row.style.display === "" || row.style.display === "none") {
          row.style.display = "table-row";
        } else {
          row.style.display = "none";
        }
      }
    </script>
  </head>
  <body>
    <!-- Script Result Modal -->
    <div class="modal fade" id="scriptModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Script Execution Result</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <pre id="scriptOutput" style="white-space: pre-wrap"></pre>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      function runScript(sourceId) {
        fetch("/run_script/" + sourceId)
          .then((response) => response.json())
          .then((data) => {
            let outputText = "";

            if (data.status === "Success") {
              outputText = "âœ… SUCCESS\n\n" + data.output;
            } else if (data.status === "Failed") {
              outputText = "âŒ FAILED\n\n" + data.output;
            } else {
              outputText = "âš  ERROR\n\n" + data.message;
            }

            // document.getElementById("scriptOutput").textContent = outputText;
            document.getElementById("scriptOutput").textContent =
              "â³ Running script...";

            let modal = new bootstrap.Modal(
              document.getElementById("scriptModal"),
            );
            modal.show();
          });
      }

      function refreshMonitor() {
        let btn = document.getElementById("refreshBtn");

        btn.disabled = true;
        btn.innerHTML = "â³ Refreshing...";

        fetch("/refresh")
          .then((response) => response.json())
          .then((data) => {
            location.reload();
          })
          .catch((error) => {
            alert("Error refreshing monitor");
            btn.disabled = false;
            btn.innerHTML = "ðŸ”„ Refresh Monitor";
          });
      }
    </script>

    <div class="container-fluid mt-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">ðŸ”Ž URL Monitor Dashboard</h3>
        <button
          id="refreshBtn"
          class="btn btn-primary"
          onclick="refreshMonitor()"
        >
          ðŸ”„ Refresh Monitor
        </button>
      </div>

      <!-- Status Cards -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card text-white bg-primary shadow card-hover">
            <div class="card-body">
              <h5>Total Sources</h5>
              <h2>{{ total }}</h2>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card text-white bg-danger shadow card-hover">
            <div class="card-body">
              <h5>Changed</h5>
              <h2>{{ changed }}</h2>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card text-white bg-success shadow card-hover">
            <div class="card-body">
              <h5>No Change</h5>
              <h2>{{ no_change }}</h2>
            </div>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="card shadow">
        <div class="card-header bg-dark text-white">
          Source Monitoring Status
        </div>
        <div class="card-body table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Source ID</th>
                <th>Status</th>
                <th>Last Checked</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for source_id, info in data.items() %}
              <tr>
                <td class="fw-bold">{{ source_id }}</td>

                <td>
                  {% if info.overall_status == "Changed" %}
                  <span class="badge bg-danger">Changed</span>
                  {% else %}
                  <span class="badge bg-success">No Change</span>
                  {% endif %}
                </td>

                <td>{{ info.last_checked }}</td>

                <td>
                  <button
                    class="btn btn-sm btn-outline-secondary"
                    onclick="toggleDetails('{{ source_id }}')"
                  >
                    Details
                  </button>

                  <button
                    class="btn btn-sm btn-success"
                    onclick="runScript('{{ source_id }}')"
                  >
                    â–¶ Run Script
                  </button>
                </td>
              </tr>

              <!-- Expand Row -->
              <tr id="details-{{ source_id }}" class="details-row">
                <td colspan="4">
                  <div class="card card-body bg-light">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr>
                          <th>URL</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for u in info.urls %}
                        <tr>
                          <td class="text-break">{{ u.url }}</td>
                          <td>
                            {% if u.status == "Changed" %}
                            <span class="badge bg-danger">Changed</span>
                            {% elif u.status == "New" %}
                            <span class="badge bg-info">New</span>
                            {% elif u.status == "Error" %}
                            <span class="badge bg-warning text-dark"
                              >Error</span
                            >
                            {% else %}
                            <span class="badge bg-success">No Change</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>

              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </body>
</html>
